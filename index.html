<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¢³å‰ TanJi - ç¤¾å€æ°£å€™éŸŒæ€§èˆ‡ NbS æ±ºç­–å¹³å°">
    <meta name="robots" content="noindex">
    <title>ç¢³å‰ TanJi - ç¤¾å€å¾®æ°£å€™éŸŒæ€§èˆ‡ NbS æ±ºç­–å¹³å°</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- docx.js & FileSaver.js -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            green: '#059669', // Emerald 600
                            light: '#d1fae5', // Emerald 100
                            dark: '#064e3b',  // Emerald 900
                            blue: '#0ea5e9',  // Sky 500
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float-up': 'float-up 2s infinite linear',
                        'float-gentle': 'float-gentle 3s infinite ease-in-out',
                    },
                    keyframes: {
                        'float-up': {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '50%': { opacity: '0.6' },
                            '100%': { transform: 'translateY(-20px)', opacity: '0' },
                        },
                        'float-gentle': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        /* ä¿®æ­£ï¼šç§»é™¤ç¶ è‰²åœ“é»ï¼Œæ”¹ç”¨ä¹¾æ·¨çš„æ¼¸å±¤èƒŒæ™¯ */
        .hero-pattern {
            background: linear-gradient(to bottom right, #f8fafc, #edf7f3);
            opacity: 1;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #059669;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #059669;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #059669;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .bar-transition {
            transition: width 1s ease-in-out, background-color 0.5s;
        }
        /* Map Container Fix */
        #risk-map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        /* Leaflet Control Layer Fix */
        .leaflet-control-layers {
            border: none !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 14px;
            padding: 8px !important;
        }
        
        /* New Textures for Simulator */
        .bg-concrete-pattern {
            background-color: #e2e8f0;
            /* ç§»é™¤è¤‡é›œ SVG ç´‹ç†ï¼Œæ”¹ç”¨ç´”è‰²ç¢ºä¿ä¸å¹²æ“¾ */
        }
        .bg-nature-pattern {
            background-color: #dcfce7;
        }
        
        /* é—œéµä¿®æ­£ï¼šç¢ºä¿å‰å¾Œåœ–å±¤çµ•å°é‡ç–Šä¸”ç‹€æ…‹æ­£ç¢º */
        .sim-layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out;
            backface-visibility: hidden; /* é˜²æ­¢é–ƒçˆ */
        }
        
        /* ç•¶ä¸é€æ˜åº¦ç‚º 0 æ™‚ï¼Œé¿å…æ“‹ä½é»æ“Š */
        .opacity-0 {
            opacity: 0 !important;
            pointer-events: none; 
            z-index: 0;
        }
        
        /* é¡¯ç¤ºæ™‚å±¤ç´šè¼ƒé«˜ */
        .opacity-100 {
            opacity: 1 !important;
            z-index: 10;
        }
    </style>
</head>
<body class="font-sans text-slate-800 antialiased bg-slate-50">

    <!-- Navigation -->
    <nav class="glass-nav fixed w-full z-50 top-0 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <div class="w-10 h-10 bg-gradient-to-br from-brand-green to-brand-blue rounded-lg flex items-center justify-center text-white font-bold text-xl">
                        <i class="fa-solid fa-leaf"></i>
                    </div>
                    <span class="font-bold text-2xl tracking-tight text-slate-800">ç¢³å‰ <span class="text-brand-green font-light">TanJi</span></span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="#features" class="text-slate-600 hover:text-brand-green font-medium transition">æ ¸å¿ƒåŠŸèƒ½</a>
                    <a href="#demo-scan" class="text-slate-600 hover:text-brand-green font-medium transition">é¢¨éšªå¿«ç¯©</a>
                    <a href="#demo-sim" class="text-slate-600 hover:text-brand-green font-medium transition">æ•ˆç›Šæ¨¡æ“¬</a>
                    <a href="#impact" class="text-slate-600 hover:text-brand-green font-medium transition">é æœŸæˆæœ</a>
                </div>
                <div></div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden">
        <div class="absolute inset-0 hero-pattern -z-10"></div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-5xl md:text-7xl font-extrabold text-slate-900 tracking-tight mb-8 leading-tight">
                ç‚ºæ‚¨çš„ç¤¾å€ç©¿ä¸Š<br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-green to-brand-blue">ç¶ è‰²æ°£å€™é˜²è­·è¡£</span>
            </h1>
            <p class="max-w-2xl mx-auto text-xl text-slate-600 mb-10 leading-relaxed">
                ç¤¾å€æ°£å€™éŸŒæ€§æ±ºç­–å¹³å°ï¼šçµåˆ GIS å¤§æ•¸æ“šèˆ‡ NbS è‡ªç„¶è§£æ–¹ï¼Œ
                å”åŠ©ç®¡å§”æœƒå¾ã€Œé¢¨éšªè¨ºæ–·ã€åˆ°ã€Œæ”¹é€ è£œåŠ©ã€ä¸€ç«™å¼å®Œæˆã€‚
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button onclick="document.getElementById('demo-scan').scrollIntoView({behavior: 'smooth'})" class="px-8 py-4 bg-brand-green hover:bg-emerald-600 text-white text-lg font-bold rounded-xl shadow-lg shadow-emerald-200 transition transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-magnifying-glass-location"></i>
                    æª¢æ¸¬æˆ‘çš„ç¤¾å€
                </button>
            </div>
            
            <!-- Platform Concept Explainer -->
            <div class="mt-16 relative mx-auto max-w-5xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden bg-white">
                <div class="bg-gradient-to-r from-slate-50 to-white p-8 md:p-12">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="w-full md:w-1/2 text-left space-y-6">
                            <h3 class="text-2xl font-bold text-slate-800">TanJi å¹³å°é‹ä½œé‚è¼¯</h3>
                            <p class="text-slate-600 text-lg">
                                å°ˆç‚ºç¤¾å€ç®¡å§”æœƒè¨­è¨ˆçš„æ°£å€™èª¿é©æ•¸ä½åŠ©ç†ã€‚æˆ‘å€‘ä¸åªå‘Šè¨´æ‚¨ã€Œå“ªè£¡ç†±ã€ï¼Œæ›´ç›´æ¥æä¾›ã€Œæ€éº¼è§£ã€çš„ç§‘å­¸æ–¹æ¡ˆã€‚
                            </p>

                            <ul class="space-y-4">
                                <li class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="fa-solid fa-database"></i></div>
                                    <div><div class="font-bold text-slate-800">1. æ•¸æ“šåŒ¯æµ</div><div class="text-sm text-slate-500">ä¸²æ¥æ°£è±¡å±€èˆ‡æ–°åŒ—å¸‚GISåœ–è³‡</div></div>
                                </li>
                                <li class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i class="fa-solid fa-magnifying-glass-chart"></i></div>
                                    <div><div class="font-bold text-slate-800">2. é¢¨éšªæŒ‡èª</div><div class="text-sm text-slate-500">AI åˆ¤è®€éƒ½å¸‚ç†±å³¶ç†±é»èˆ‡æ·¹æ°´æ½›å‹¢</div></div>
                                </li>
                                <li class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-brand-light flex items-center justify-center text-brand-green"><i class="fa-solid fa-tree"></i></div>
                                    <div><div class="font-bold text-slate-800">3. è‡ªç„¶è§£æ–¹ (NbS)</div><div class="text-sm text-slate-500">æ¨è–¦é©åœ°é©ç¨®çš„ç¶ åŒ–èˆ‡ä¿æ°´æ–¹æ¡ˆ</div></div>
                                </li>
                            </ul>
                        </div>
                        <div class="w-full md:w-1/2 bg-slate-100 rounded-xl p-6 relative">
                            <div class="relative z-10 grid grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><i class="fa-solid fa-cloud-rain text-3xl text-blue-500 mb-2"></i><div class="font-bold text-sm">æ°£å€™æ•¸æ“š</div></div>
                                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><i class="fa-solid fa-building text-3xl text-slate-500 mb-2"></i><div class="font-bold text-sm">å»ºç¯‰åœ–è³‡</div></div>
                                <div class="col-span-2 bg-brand-green text-white p-4 rounded-lg shadow-lg text-center transform scale-105">
                                    <i class="fa-solid fa-microchip text-3xl mb-2"></i>
                                    <div class="font-bold text-lg">TanJi AI æ ¸å¿ƒå¼•æ“</div>
                                </div>
                                <div class="col-span-2 bg-white p-4 rounded-lg shadow-sm text-center border-t-4 border-brand-green">
                                    <div class="font-bold text-brand-dark">è¡Œå‹•è¨ˆç•«æ›¸ (Action Plan)</div>
                                </div>
                            </div>
                            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')] opacity-10"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Interactive Demo 1: Risk Scan -->
    <section id="demo-scan" class="py-20 bg-slate-900 text-white relative overflow-hidden">
        <div class="absolute top-0 left-0 w-64 h-64 bg-brand-green rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-brand-blue rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>

        <div class="max-w-4xl mx-auto px-4 relative z-10">
            <div class="text-center mb-12">
                <span class="text-brand-green font-bold tracking-wider uppercase text-sm">Interactive Demo 01</span>
                <h2 class="text-3xl md:text-4xl font-bold mt-2">è©¦è©¦çœ‹ï¼šç¤¾å€é¢¨éšªå¿«ç¯©</h2>
                <p class="text-slate-400 mt-4">è¼¸å…¥æ–°åŒ—å¸‚åœ°å€ï¼Œé«”é©— AI è¨ºæ–·æµç¨‹</p>
            </div>

            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 shadow-2xl">
                <div class="flex flex-col sm:flex-row gap-4 mb-8">
                    <div class="flex-grow relative">
                        <i class="fa-solid fa-location-dot absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="address-input" value="" class="w-full bg-slate-800 border border-slate-600 rounded-lg py-4 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:border-brand-green transition" placeholder="è«‹è¼¸å…¥æ–°åŒ—å¸‚ç¤¾å€åœ°å€...">
                    </div>
                    <button onclick="startAnalysis()" class="bg-brand-green hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-lg transition shadow-lg flex items-center justify-center gap-2 min-w-[160px]">
                        <span id="btn-text">é–‹å§‹åˆ†æ</span>
                        <div id="btn-loader" class="loader hidden w-5 h-5 border-2 border-white border-t-transparent"></div>
                    </button>
                </div>
                
                <div class="mb-6 flex flex-wrap gap-2 justify-center text-xs text-slate-400">
                    <div class="api-status flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full border border-white/10 transition-colors duration-300">
                        <div id="status-dot-ntpc" class="status-dot w-2 h-2 rounded-full bg-slate-500"></div> ä¸²æ¥ï¼šOpenStreetMap å®šä½æœå‹™
                    </div>
                    <div class="api-status flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full border border-white/10 transition-colors duration-300">
                        <div id="status-dot-cwa" class="status-dot w-2 h-2 rounded-full bg-slate-500"></div> ä¸²æ¥ï¼šCWA ä¸­å¤®æ°£è±¡ç½²
                    </div>
                    <div class="api-status flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full border border-white/10 transition-colors duration-300">
                        <div id="status-dot-ncdr" class="status-dot w-2 h-2 rounded-full bg-slate-500"></div> ä¸²æ¥ï¼šNCDR æ·¹æ°´æ½›å‹¢åœ–
                    </div>
                </div>
                
                <div id="status-message" class="text-center text-sm text-brand-green font-mono h-6 mb-4 opacity-0 transition-opacity">
                    æ­£åœ¨é€£ç·šè‡³ API...
                </div>

                <div id="analysis-result" class="hidden transition-all duration-500 opacity-0 transform translate-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- çœŸå¯¦äº’å‹•åœ°åœ–å€å¡Š -->
                        <div class="bg-slate-800 rounded-xl overflow-hidden h-64 relative border border-slate-700 shadow-inner">
                            <div id="risk-map"></div>
                            <!-- è¦†è“‹åœ¨åœ°åœ–ä¸Šçš„æµ®å‹•æ¨™ç±¤ -->
                            <div class="absolute bottom-2 right-2 z-[999]">
                                <span class="bg-white/90 text-slate-800 px-2 py-1 rounded text-[10px] font-bold shadow">
                                    <i class="fa-solid fa-layer-group mr-1"></i>OSM + NCDR
                                </span>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-red-500/20 border border-red-500/50 p-4 rounded-xl flex items-start gap-4">
                                <div class="bg-red-500 p-2 rounded-lg text-white"><i class="fa-solid fa-temperature-full"></i></div>
                                <div>
                                    <h4 class="font-bold text-red-200" id="result-temp-title">å³æ™‚é«˜æº«è§€æ¸¬</h4>
                                    <p class="text-sm text-slate-300 mt-1" id="result-temp-desc">è®€å–ä¸­...</p>
                                    <p class="text-xs text-slate-400 mt-1" id="api-debug-info"></p>
                                </div>
                            </div>
                            <div class="bg-blue-500/20 border border-blue-500/50 p-4 rounded-xl flex items-start gap-4">
                                <div class="bg-blue-500 p-2 rounded-lg text-white"><i class="fa-solid fa-cloud-showers-heavy"></i></div>
                                <div>
                                    <h4 class="font-bold text-blue-200" id="result-flood-title">æ’æ°´è² è·è­¦ç¤º</h4>
                                    <p class="text-sm text-slate-300 mt-1" id="result-flood-desc">çŸ­å»¶æ™‚å¼·é™é›¨ç™¼ç”Ÿæ©Ÿç‡é«˜ï¼Œå»ºè­°æå‡ç¤¾å€é€æ°´ç‡ã€‚</p>
                                </div>
                            </div>
                            <div class="bg-brand-green p-4 rounded-xl text-center cursor-pointer hover:bg-emerald-600 transition" onclick="document.getElementById('demo-sim').scrollIntoView({behavior: 'smooth'})">
                                <p class="font-bold text-white"><i class="fa-solid fa-arrow-right mr-2"></i> å‰å¾€ NbS æ¨¡æ“¬å™¨æ”¹å–„</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Interactive Demo 2: Simulator -->
    <section id="demo-sim" class="py-20 bg-slate-50">
        <!-- ä¿®æ­£å¯¬åº¦ç‚º max-w-7xlï¼Œè§£æ±ºç‰ˆé¢ä¸å°ç¨±å•é¡Œ -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Layout: Visualizer on LEFT, Controls on RIGHT -->
            <div class="flex flex-col-reverse md:flex-row gap-12 items-start relative">
                
                <!-- Left: Visualizer (Modified: Clean Layout) -->
                <div class="w-full md:w-2/3 bg-white rounded-3xl shadow-xl p-8 border border-slate-100 relative overflow-hidden flex flex-col sticky top-24">
                    <!-- Improved Visualizer Window -->
                    <div class="h-[500px] rounded-xl bg-slate-100 mb-8 overflow-hidden relative group shrink-0 border border-slate-200">
                        
                        <!-- Before State (Layer 1: Bottom) -->
                        <div id="img-before" class="sim-layer bg-concrete-pattern opacity-100">
                            <div class="relative z-10 text-center">
                                <div class="mb-4 inline-block">
                                    <i class="fa-solid fa-city text-8xl text-slate-400"></i>
                                </div>
                                <p class="text-slate-600 font-bold text-2xl tracking-wide">åŸå§‹ç¾æ³</p>
                                <p class="text-slate-500 text-sm mt-1">æ°´æ³¥é‹ªé¢ / é«˜è“„ç†± / æ’æ°´ä¸è‰¯</p>
                            </div>
                        </div>

                        <!-- After State (Layer 2: Top, toggles opacity) -->
                        <div id="img-after" class="sim-layer bg-nature-pattern opacity-0">
                             <div class="relative z-10 text-center">
                                <div class="mb-4 inline-block">
                                    <i class="fa-solid fa-building-circle-check text-8xl text-brand-green"></i>
                                </div>
                                <p class="text-brand-green font-bold text-2xl tracking-wide" id="visual-label-after">æ¨¡æ“¬æ•ˆæœ</p>
                                <p class="text-slate-600 text-sm mt-1">ç¶ åŒ–æ¤æ ½ / é™æº« / åŸºåœ°ä¿æ°´</p>
                            </div>
                        </div>

                        <!-- Badge (Always Top) -->
                        <div class="absolute bottom-4 left-4 z-20 bg-white/90 text-slate-700 px-4 py-2 rounded-full text-sm font-bold shadow-lg backdrop-blur transition-all duration-500 border border-slate-200" id="img-badge">
                            <span id="img-label"><i class="fa-solid fa-triangle-exclamation text-red-500 mr-2"></i>åŸå§‹é¢¨éšªç‹€æ…‹</span>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-base font-bold text-slate-600" id="chart-title-1"><i class="fa-solid fa-temperature-high mr-2"></i>é ‚æ¨“å¤å­£è¡¨é¢æº«åº¦</span>
                                <span id="val-temp" class="text-base font-bold text-red-500">55Â°C</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-6 border border-slate-200">
                                <div id="bar-temp" class="bg-red-500 h-6 rounded-full bar-transition shadow-sm relative" style="width: 95%">
                                    <div class="absolute inset-0 bg-white/20 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-base font-bold text-slate-600" id="chart-title-2"><i class="fa-solid fa-bolt mr-2"></i>å¹´æ•ˆç›Šè©•ä¼°</span>
                                <span id="val-carbon" class="text-base font-bold text-slate-400">0</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-6 border border-slate-200">
                                <div id="bar-carbon" class="bg-brand-green h-6 rounded-full bar-transition shadow-sm" style="width: 2%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Controls & Generation (Modified: Removed sticky) -->
                <div class="w-full md:w-1/3 space-y-8">
                    <div>
                        <span class="text-brand-green font-bold tracking-wider uppercase text-sm">Interactive Demo 02</span>
                        <h2 class="text-3xl font-bold mt-2 text-slate-900">NbS æ•ˆç›Šæ¨¡æ“¬å™¨</h2>
                        <p class="text-slate-600 mt-4" id="sim-desc">
                            é¸æ“‡é©åˆçš„æ°£å€™éŸŒæ€§æ–¹æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•æ¨¡æ“¬é™æº«èˆ‡æ¸›ç¢³æ•ˆç›Šï¼Œä¸¦è©¦ç®—æ”¿åºœè£œåŠ©é‡‘é¡ã€‚
                        </p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-6">
                        
                        <!-- 0. ç”³è«‹å–®ä½è³‡æ–™ (NEW) -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">ç”³è«‹å–®ä½ (ç¤¾å€å…¨éŠœ)</label>
                            <input type="text" id="sim-org-name" class="w-full border border-slate-300 rounded-lg py-2 px-4 focus:ring-2 focus:ring-brand-green focus:border-transparent outline-none transition text-sm" placeholder="å¦‚ï¼šXXç¤¾å€ç®¡ç†å§”å“¡æœƒ">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">ç¤¾å€åœ°å€</label>
                            <input type="text" id="sim-address" class="w-full border border-slate-300 rounded-lg py-2 px-4 focus:ring-2 focus:ring-brand-green focus:border-transparent outline-none transition text-sm" placeholder="æ–°åŒ—å¸‚...">
                        </div>

                        <!-- 1. é¸æ“‡æ”¹é€ é …ç›® -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">è¨ˆç•«æ”¹é€ é …ç›®</label>
                            <select id="sim-type" onchange="updateCalculations()" class="w-full border border-slate-300 rounded-lg py-2 px-3 focus:ring-2 focus:ring-brand-green outline-none transition text-slate-700 font-medium">
                                <option value="nbs">1. ç”Ÿç‰©å¤šæ¨£æ€§èˆ‡ç¶ åŒ– (NbS)</option>
                                <option value="water">2. æ°´è³‡æºå†åˆ©ç”¨ (é›¨æ°´/é€æ°´)</option>
                                <option value="insulation">3. å»ºç¯‰å¤–æ®¼ç¯€èƒ½ (éš”ç†±)</option>
                            </select>
                        </div>

                        <!-- æ–°å¢ï¼šæ–½ä½œä½ç½®é¸æ“‡ (æä¾›é™¤äº†é ‚æ¨“ä»¥å¤–çš„é¸é …) -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">æ–½ä½œä½ç½®</label>
                            <select id="sim-location" onchange="updateCalculations()" class="w-full border border-slate-300 rounded-lg py-2 px-3 focus:ring-2 focus:ring-brand-green outline-none transition text-slate-700 font-medium">
                                <option value="rooftop">é ‚æ¨“ (å±‹é ‚å±¤)</option>
                                <option value="facade">å»ºç¯‰å¤–ç‰† (ç«‹é¢)</option>
                                <option value="ground">ä¸€æ¨“ä¸­åº­/é–‹æ”¾ç©ºé–“</option>
                            </select>
                        </div>

                        <!-- 2. ç¤¾å€ç¸½æˆ¶æ•¸ -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">ç¤¾å€ç¸½æˆ¶æ•¸</label>
                            <div class="relative">
                                <input type="number" id="sim-households" value="200" oninput="updateCalculations()" class="w-full border border-slate-300 rounded-lg py-2 px-4 focus:ring-2 focus:ring-brand-green focus:border-transparent outline-none transition font-mono text-lg text-right">
                                <span class="absolute left-4 top-2.5 text-slate-400 text-sm"><i class="fa-solid fa-users"></i></span>
                            </div>
                            <p class="text-xs text-slate-400 mt-1" id="household-type">ä¸­å‹ç¤¾å€ (è£œåŠ©ä¸Šé™20è¬)</p>
                        </div>

                        <!-- 3. è¼¸å…¥é¢ç© -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">é è¨ˆæ–½ä½œé¢ç© (åª)</label>
                            <div class="relative">
                                <input type="number" id="sim-area" value="30" oninput="updateCalculations()" class="w-full border border-slate-300 rounded-lg py-2 px-4 focus:ring-2 focus:ring-brand-green focus:border-transparent outline-none transition font-mono text-lg text-right">
                                <span class="absolute left-4 top-2.5 text-slate-400 text-sm"><i class="fa-solid fa-ruler-combined"></i></span>
                            </div>
                        </div>

                        <!-- 4. é–‹é—œæ¨¡æ“¬ -->
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-slate-700">å•Ÿç”¨æ¨¡æ“¬è¦–åœ–</span>
                            <div class="relative inline-block w-14 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="sim-toggle" class="toggle-checkbox absolute block w-8 h-8 rounded-full bg-white border-4 border-slate-300 appearance-none cursor-pointer transition-all duration-300 top-[-4px] left-[-4px]" onchange="toggleSimulation()"/>
                                <label for="sim-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <!-- 5. å³æ™‚ç¶“è²»è©¦ç®— -->
                        <div id="cost-preview" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm space-y-3 animate-pulse-fast" style="animation-iteration-count: 1;">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500">é ä¼°ç¸½ç¶“è²»</span>
                                <span class="font-bold text-slate-800 text-lg" id="val-total-cost">$0</span>
                            </div>
                            <div class="flex justify-between items-center text-brand-green">
                                <span><i class="fa-solid fa-hand-holding-dollar mr-1"></i> æ”¿åºœè£œåŠ©</span>
                                <span class="font-bold text-lg" id="val-subsidy">$0</span>
                            </div>
                            <div class="flex justify-between items-center border-t border-slate-200 pt-3">
                                <span class="text-slate-500">é ä¼°å›æ”¶å¹´é™</span>
                                <span class="font-bold text-slate-800" id="val-roi">-- å¹´</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <button id="btn-generate" onclick="generateSubsidyDoc()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2 transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa-solid fa-file-signature"></i>
                        ä¸€éµç”Ÿæˆæ”¹é€ è£œåŠ©è¨ˆç•«æ›¸
                    </button>
                    <p class="text-center text-xs text-slate-400 mt-2">* è‡ªå‹•å¡«å…¥æ–°åŒ—å¸‚ç’°ä¿å±€æ ¼å¼è¡¨æ ¼</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-leaf text-brand-green"></i>
                        <span class="font-bold text-xl">ç¢³å‰ TanJi</span>
                    </div>
                    <p class="text-slate-400 text-sm">æ•™è‚²éƒ¨ 115 å¹´åº¦æ°£å€™è®Šé·å‰µæ„å¯¦ä½œç«¶è³½åƒè³½éšŠä¼</p>
                </div>
                <!-- å·²ç§»é™¤ GitHub åœ–ç¤ºèˆ‡é€£çµ -->
                <div class="flex gap-6"></div>
            </div>
            <div class="border-t border-slate-800 mt-8 pt-8 text-center text-slate-500 text-sm">
                &copy; 2026 TanJi Project. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // --- æ ¸å¿ƒï¼šé …ç›®åƒæ•¸è¨­å®š ---
        const COST_DB = {
            "nbs": { 
                title: "ç”Ÿç‰©å¤šæ¨£æ€§èˆ‡ç¶ åŒ– (NbS)", 
                cost: 25000, 
                subsidyRate: 0.5, 
                desc: "å»ºç½®è–„å±¤ç¶ å±‹é ‚èˆ‡ç”Ÿæ…‹è·³å³¶ï¼Œç¨®æ¤åŸç”Ÿè€æ—±æ¤æ ½ã€‚", 
                benefitUnit: "åº¦é›» (ç©ºèª¿ç¯€èƒ½)",
                benefitFactor: 60, // æ¯åªçœé›»åº¦æ•¸
                visualText: "å°å…¥ç¶ å±‹é ‚å¾Œ",
                chart1Title: "é ‚æ¨“å¤å­£è¡¨é¢æº«åº¦",
                chart1Base: 55, chart1Improv: 32 // æ”¹å–„å¾Œæº«åº¦
            },
            "water": { 
                title: "æ°´è³‡æºå†åˆ©ç”¨ (é›¨æ°´/é€æ°´)", 
                cost: 15000, 
                subsidyRate: 0.5, 
                desc: "è¨­ç½®é›¨æ°´è²¯ç•™æ¡¶èˆ‡é€æ°´é‹ªé¢ï¼Œæ‰“é€ é›¨æ°´èŠ±åœ’ã€‚", 
                benefitUnit: "åº¦æ°´ (ç¯€çœè‡ªä¾†æ°´)",
                benefitFactor: 30, // æ¯åªçœæ°´é‡(å™¸)
                visualText: "å°å…¥é›¨æ°´å›æ”¶å¾Œ",
                chart1Title: "æš´é›¨é€•æµå‰Šæ¸›ç‡",
                chart1Base: 0, chart1Improv: 85 // å‰Šæ¸› 85%
            },
            "insulation": { 
                title: "å»ºç¯‰å¤–æ®¼ç¯€èƒ½ (éš”ç†±)", 
                cost: 8000, 
                subsidyRate: 0.4, 
                desc: "å¡—ä½ˆé«˜æ•ˆéš”ç†±æ¼†æˆ–é‹ªè¨­éš”ç†±ç£šï¼Œé˜»çµ•ç†±èƒ½å‚³å°ã€‚", 
                benefitUnit: "åº¦é›» (ç©ºèª¿ç¯€èƒ½)",
                benefitFactor: 40,
                visualText: "æ–½ä½œéš”ç†±å·¥ç¨‹å¾Œ",
                chart1Title: "å®¤å…§å¤©èŠ±æ¿æº«åº¦",
                chart1Base: 42, chart1Improv: 36
            }
        };

        const ELECTRICITY_RATE = 4.5; 
        const WATER_RATE = 12; // æ°´è²»å‡è¨­

        /*
         * æ–°åŒ—å¸‚é–€ç‰Œä½ç½®è³‡æ–™åº« - æ¨¡æ“¬è³‡æ–™ (Fallback ç”¨)
         */
        const MOCK_NTPC_ADDRESS_DB = {
            "æ¿æ©‹": { lat: 25.014, lng: 121.463, name: "æ¿æ©‹å€" },
            "ä¸‰é‡": { lat: 25.061, lng: 121.492, name: "ä¸‰é‡å€" },
            "ä¸­å’Œ": { lat: 24.999, lng: 121.503, name: "ä¸­å’Œå€" },
            "æ°¸å’Œ": { lat: 25.008, lng: 121.517, name: "æ°¸å’Œå€" },
            "æ–°èŠ": { lat: 25.036, lng: 121.450, name: "æ–°èŠå€" },
            "æ–°åº—": { lat: 24.978, lng: 121.539, name: "æ–°åº—å€" },
            "åœŸåŸ": { lat: 24.973, lng: 121.444, name: "åœŸåŸå€" },
            "è˜†æ´²": { lat: 25.085, lng: 121.472, name: "è˜†æ´²å€" },
            "æ¨¹æ—": { lat: 24.991, lng: 121.424, name: "æ¨¹æ—å€" },
            "é¶¯æ­Œ": { lat: 24.953, lng: 121.353, name: "é¶¯æ­Œå€" },
            "ä¸‰å³½": { lat: 24.934, lng: 121.368, name: "ä¸‰å³½å€" },
            "åŒ—å¤§": { lat: 24.945, lng: 121.375, name: "åŒ—å¤§ç‰¹å€" },
            "æ·¡æ°´": { lat: 25.175, lng: 121.444, name: "æ·¡æ°´å€" },
            "æ±æ­¢": { lat: 25.067, lng: 121.659, name: "æ±æ­¢å€" },
            "ç‘èŠ³": { lat: 25.108, lng: 121.805, name: "ç‘èŠ³å€" },
            "äº”è‚¡": { lat: 25.083, lng: 121.439, name: "äº”è‚¡å€" },
            "æ³°å±±": { lat: 25.059, lng: 121.428, name: "æ³°å±±å€" },
            "æ—å£": { lat: 25.077, lng: 121.391, name: "æ—å£å€" },
            "æ·±å‘": { lat: 25.002, lng: 121.615, name: "æ·±å‘å€" },
            "çŸ³ç¢‡": { lat: 24.991, lng: 121.660, name: "çŸ³ç¢‡å€" },
            "åªæ—": { lat: 24.936, lng: 121.711, name: "åªæ—å€" },
            "ä¸‰èŠ": { lat: 25.258, lng: 121.500, name: "ä¸‰èŠå€" },
            "çŸ³é–€": { lat: 25.290, lng: 121.567, name: "çŸ³é–€å€" },
            "å…«é‡Œ": { lat: 25.146, lng: 121.399, name: "å…«é‡Œå€" },
            "å¹³æºª": { lat: 25.025, lng: 121.739, name: "å¹³æºªå€" },
            "é›™æºª": { lat: 25.032, lng: 121.865, name: "é›™æºªå€" },
            "è²¢å¯®": { lat: 25.022, lng: 121.942, name: "è²¢å¯®å€" },
            "é‡‘å±±": { lat: 25.222, lng: 121.638, name: "é‡‘å±±å€" },
            "è¬é‡Œ": { lat: 25.179, lng: 121.689, name: "è¬é‡Œå€" },
            "çƒä¾†": { lat: 24.872, lng: 121.550, name: "çƒä¾†å€" },
            "default": { lat: 25.012, lng: 121.465, name: "æ–°åŒ—å¸‚ (é è¨­)" }
        };

        // Global Map Variable
        let map = null;
        let heatCircle = null;
        let ncdrLayer = null; // æ–°å¢ï¼šNCDR åœ–å±¤è®Šæ•¸
        let osmLayer = null;  // åº•åœ–è®Šæ•¸
        let ncdrEmapLayer = null; // æ¸¬è©¦ç”¨ï¼šé›»å­åœ°åœ–

        // Initialize Map
        document.addEventListener('DOMContentLoaded', () => {
            map = L.map('risk-map').setView([25.012, 121.465], 11);
            
            // 1. åº•åœ– (OpenStreetMap)
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OSM contributors'
            });
            osmLayer.addTo(map);

            // 2. æ–°å¢ï¼šNCDR æ·¹æ°´æ½›å‹¢åœ– (WMTS æœå‹™ - WRA_FLOOD_600)
            // é—œéµä¿®æ­£ï¼šåŠ å…¥ maxNativeZoom: 12ï¼Œé˜²æ­¢ç¸®æ”¾éè¿‘å°è‡´åœ–ç‰‡æ¶ˆå¤±
            // ä¸¦åŠ ä¸Š .png å‰¯æª”åä¿®æ­£ (Critical Fix)
            ncdrLayer = L.tileLayer('https://wmts.ncdr.nat.gov.tw/wmts/WRA_FLOOD_600/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
                maxZoom: 20,
                maxNativeZoom: 12, // â­ï¸ é‡è¦ï¼šè‹¥ä¼ºæœå™¨æ²’é«˜æ¸…åœ–ï¼Œè‡ªå‹•æ”¾å¤§ä½æ¸…åœ–ï¼Œç¢ºä¿ä¸æ¶ˆå¤±
                opacity: 0.8, // å¢åŠ ä¸é€æ˜åº¦åˆ° 0.8ï¼Œç¢ºä¿çœ‹å¾—åˆ°
                attribution: 'NCDR æ·¹æ°´æ½›å‹¢åœ–',
                zIndex: 1000 // å¼·åˆ¶ç½®é ‚
            });

            // 3. æ–°å¢ï¼šNCDR é€šç”¨é›»å­åœ°åœ– (æ¸¬è©¦ç”¨ - ä¸é€æ˜)
            ncdrEmapLayer = L.tileLayer('https://wmts.ncdr.nat.gov.tw/wmts/EMAP5/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
                maxZoom: 20,
                maxNativeZoom: 15,
                opacity: 1.0, 
                attribution: 'NCDR é›»å­åœ°åœ–',
                zIndex: 500
            });

            // (å·²ç§»é™¤) 4. åŠ å…¥åœ–å±¤æ§åˆ¶å™¨ - ç‚ºäº†ç•«é¢ç°¡æ½”æš«æ™‚ç§»é™¤æ‰‹å‹•é–‹é—œ
            // const overlayMaps = {
            //     "ğŸ”´ NCDR æ·¹æ°´æ½›å‹¢åœ– (600mm)": ncdrLayer,
            //     "ğŸ—ºï¸ NCDR é€šç”¨é›»å­åœ°åœ– (æ¸¬è©¦é€£ç·š)": ncdrEmapLayer
            // };
            // L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);
        });

        // è¼”åŠ©å‡½å¼ï¼šå–å¾— Mock æº«åº¦ (ç•¶å¾Œç«¯é€£ç·šå¤±æ•—æ™‚çš„å‚™æ¡ˆ)
        function getMockTemp() {
            const now = new Date();
            const month = now.getMonth() + 1;
            let temp = 25;
            let risk = "";
            let color = "";

            if (month >= 11 || month <= 2) {
                temp = (Math.random() * (22 - 16) + 16).toFixed(1);
                risk = "æº«åº¦åä½ï¼Œé©åˆè©•ä¼°å»ºç¯‰ä¿æº«æ•ˆç›Šã€‚";
                color = "#3b82f6";
            } else if (month >= 6 && month <= 9) {
                temp = (Math.random() * (36 - 30) + 30).toFixed(1);
                risk = "é«˜æ–¼å€åŸŸå¹³å‡ï¼Œå±¬ç†±å³¶æ•ˆæ‡‰é«˜é¢¨éšªå€ã€‚";
                color = "#ef4444";
            } else {
                temp = (Math.random() * (28 - 22) + 22).toFixed(1);
                risk = "æ°£å€™å®œäººï¼Œå»ºè­°é€²è¡Œç¶ åŒ–ç¶­è­·ã€‚";
                color = "#22c55e";
            }
            return { temp, risk, color };
        }

        // Feature 1: Map Analysis (Full Real GIS)
        async function startAnalysis() {
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const resultDiv = document.getElementById('analysis-result');
            const statusMsg = document.getElementById('status-message');
            const cwaDot = document.getElementById('status-dot-cwa');
            const ntpcDot = document.getElementById('status-dot-ntpc'); // å®šä½æœå‹™ç‡ˆè™Ÿ
            const ncdrDot = document.getElementById('status-dot-ncdr'); // æ–°å¢ï¼šNCDR ç‡ˆè™Ÿ
            
            let userInput = document.getElementById('address-input').value;

            if (!userInput) {
                alert("è«‹è¼¸å…¥åœ°å€ä»¥é€²è¡Œåˆ†æï¼");
                return;
            }

            // --- ä¿®æ­£ 1ï¼šé˜²æ­¢å®šä½åˆ°ä¸­åœ‹ ---
            // å¦‚æœè¼¸å…¥ä¸­ä¸åŒ…å«ã€Œå°ç£ã€æˆ–ã€Œæ–°åŒ—å¸‚ã€ï¼Œå‰‡è‡ªå‹•è£œä¸Šï¼Œé™å®šæœå°‹ç¯„åœ
            // é€™è£¡ä½¿ç”¨ä¸€å€‹æ–°çš„è®Šæ•¸ queryAddress ä¾†å‚³çµ¦å¾Œç«¯
            let queryAddress = userInput;
            if (!userInput.includes("å°ç£") && !userInput.includes("æ–°åŒ—å¸‚")) {
                queryAddress = "å°ç£æ–°åŒ—å¸‚" + userInput;
            }

            // 1. UI ç‹€æ…‹æ›´æ–° (é‡ç½®æ‰€æœ‰ç‡ˆè™Ÿç‚ºç°è‰²)
            btnText.innerText = 'åˆ†æä¸­...';
            btnLoader.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            statusMsg.classList.remove('opacity-0');
            statusMsg.innerText = "æ­£åœ¨é€£ç·š GIS å®šä½ä¼ºæœå™¨...";
            
            // é‡ç½®ç‡ˆè™Ÿï¼šå…¨ç°
            ntpcDot.classList.remove('bg-brand-green', 'animate-ping');
            cwaDot.classList.remove('bg-brand-green', 'animate-ping');
            ncdrDot.classList.remove('bg-brand-green', 'animate-ping');
            
            ntpcDot.classList.add('bg-slate-500');
            cwaDot.classList.add('bg-slate-500');
            ncdrDot.classList.add('bg-slate-500');

            // æ­¥é©Ÿ A é–‹å§‹ï¼šå®šä½ç‡ˆè™Ÿé–ƒçˆ
            ntpcDot.classList.replace('bg-slate-500', 'bg-brand-green');
            ntpcDot.classList.add('animate-ping');

            try {
                // æ‚¨çš„ Vercel ç¶²å€
                const backendUrl = 'https://tanji-backend-d66y.vercel.app'; 

                // --- æ­¥é©Ÿ A: çœŸå¯¦åœ°å€å®šä½ (é›™é‡å‚™æ´æ©Ÿåˆ¶) ---
                let geoData = null;
                let locationName = userInput;

                try {
                    // æ–¹æ³• 1: å‘¼å« Vercel å¾Œç«¯ API
                    const geoRes = await fetch(`${backendUrl}/api/geocode?address=${encodeURIComponent(queryAddress)}`);
                    if (geoRes.ok) {
                        geoData = await geoRes.json();
                        locationName = geoData.name;
                    } else {
                        throw new Error("Backend geocode failed (404/500)");
                    }
                } catch (backendErr) {
                    console.warn("å¾Œç«¯å®šä½å¤±æ•—ï¼Œå˜—è©¦å‰ç«¯ç›´é€£ OSM Nominatim...", backendErr);
                    // æ–¹æ³• 2: å‰ç«¯ç›´æ¥å‘¼å« OpenStreetMap (å‚™ç”¨)
                    const osmRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(queryAddress)}&format=json&limit=1`);
                    if (osmRes.ok) {
                        const osmRaw = await osmRes.json();
                        if (osmRaw && osmRaw.length > 0) {
                            geoData = {
                                lat: parseFloat(osmRaw[0].lat),
                                lng: parseFloat(osmRaw[0].lon),
                                name: osmRaw[0].display_name
                            };
                            locationName = geoData.name;
                        }
                    }
                }

                // æª¢æŸ¥æ˜¯å¦æˆåŠŸå–å¾—åº§æ¨™
                if (!geoData) throw new Error("åœ°å€å®šä½å¤±æ•— (æ‰€æœ‰é€”å¾‘çš†ç„¡æ•ˆ)");
                
                // åº§æ¨™æŸµæ¬„æª¢æŸ¥ (Geofence Check)ï¼šå¦‚æœåœ¨å°ç£ç¯„åœå¤–ï¼Œè¦–ç‚ºå¤±æ•—
                if (geoData.lat < 21 || geoData.lat > 26 || geoData.lng < 119 || geoData.lng > 123) {
                    console.warn("å®šä½åˆ°å°ç£ä»¥å¤–å€åŸŸï¼Œå˜—è©¦å¼·åˆ¶ä¿®æ­£...");
                    statusMsg.innerText = "âš ï¸ è­¦å‘Šï¼šå®šä½çµæœä¼¼ä¹åœ¨å°ç£å¢ƒå¤–";
                }

                const locationData = {
                    lat: geoData.lat,
                    lng: geoData.lng,
                    name: locationName
                };

                // å®šä½å®Œæˆï¼šå®šä½ç‡ˆè™Ÿæ†äº®ï¼Œæ°£è±¡ç‡ˆè™Ÿé–ƒçˆ
                ntpcDot.classList.remove('animate-ping'); // åœæ­¢å®šä½é–ƒçˆ
                
                statusMsg.innerText = `å·²å®šä½ï¼š${locationData.name.substring(0, 15)}... è®€å–æ°£è±¡ä¸­...`;
                cwaDot.classList.replace('bg-slate-500', 'bg-brand-green');
                cwaDot.classList.add('animate-ping');

                // --- æ­¥é©Ÿ B: çœŸå¯¦æ°£è±¡è³‡æ–™ ---
                const weatherRes = await fetch(`${backendUrl}/api/weather`);
                if (!weatherRes.ok) throw new Error("æ°£è±¡é€£ç·šå¤±æ•—");
                const weatherRaw = await weatherRes.json();
                
                let weatherData = null;
                if (weatherRaw.records && weatherRaw.records.Station) {
                    // æ™ºæ…§æœå°‹ï¼šç›´æ¥æ‰¾é›¢ã€Œå®šä½åº§æ¨™ã€æœ€è¿‘çš„æ¸¬ç«™
                    let minDist = Infinity;
                    let nearestStation = weatherRaw.records.Station[0];

                    weatherRaw.records.Station.forEach(s => {
                        const dist = Math.sqrt(
                            Math.pow(s.GeoInfo.Coordinates[1].StationLatitude - locationData.lat, 2) + 
                            Math.pow(s.GeoInfo.Coordinates[1].StationLongitude - locationData.lng, 2)
                        );
                        if (dist < minDist) {
                            minDist = dist;
                            nearestStation = s;
                        }
                    });

                    weatherData = {
                        temp: nearestStation.WeatherElement.AirTemperature,
                        risk: `è§€æ¸¬ç«™ï¼š${nearestStation.StationName} (è·é›¢ ${(minDist*111).toFixed(1)}km)`,
                        color: nearestStation.WeatherElement.AirTemperature > 30 ? "#ef4444" : "#22c55e",
                        source: "Real API"
                    };
                }

                // æ°£è±¡å®Œæˆï¼šæ°£è±¡ç‡ˆè™Ÿæ†äº®ï¼ŒNCDR ç‡ˆè™Ÿé–ƒçˆ
                cwaDot.classList.remove('animate-ping');
                
                statusMsg.innerText = "æ­£åœ¨è¼‰å…¥ NCDR ç½å®³åœ–è³‡...";
                ncdrDot.classList.replace('bg-slate-500', 'bg-brand-green');
                ncdrDot.classList.add('animate-ping');

                // æ•…æ„å»¶é²ä¸€é»é»ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ° NCDR ç‡ˆè™Ÿåœ¨è·‘ (å¢åŠ çœŸå¯¦æ„Ÿ)
                await new Promise(r => setTimeout(r, 800));

                // 4. æ›´æ–° UI
                const now = new Date();
                const obsTime = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

                btnText.innerText = 'é‡æ–°åˆ†æ';
                btnLoader.classList.add('hidden');
                
                // å…¨éƒ¨å®Œæˆï¼šåœæ­¢ NCDR é–ƒçˆ
                ncdrDot.classList.remove('animate-ping');

                resultDiv.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                
                // 5. æ›´æ–°åœ°åœ–èˆ‡ NCDR åœ–å±¤
                if(map) {
                    map.invalidateSize();
                    map.flyTo([locationData.lat, locationData.lng], 15); 
                    
                    if(heatCircle) map.removeLayer(heatCircle);
                    heatCircle = L.circle([locationData.lat, locationData.lng], {
                        color: weatherData.color,
                        fillColor: weatherData.color,
                        fillOpacity: 0.4,
                        radius: 200 
                    }).addTo(map);
                    
                    L.marker([locationData.lat, locationData.lng])
                        .addTo(map)
                        .bindPopup(`<b>${locationData.name}</b><br>æ°£æº«: ${weatherData.temp}Â°C`)
                        .openPopup();

                    // â˜…â˜…â˜… é—œéµï¼šé è¨­å…ˆé¡¯ç¤º EMAP é€šç”¨é›»å­åœ°åœ–ï¼Œ3ç§’å¾Œè‡ªå‹•åˆ‡æ›ç‚ºæ·¹æ°´æ½›å‹¢åœ– â˜…â˜…â˜…
                    // é€™æ˜¯ä¸€å€‹ UX æŠ€å·§ï¼šå…ˆè®“ä½¿ç”¨è€…çœ‹åˆ°ã€Œæœ‰åœ–å±¤ç–Šä¸Šå»ã€çš„æ„Ÿè¦ºï¼Œå†åˆ‡æ›åˆ°ã€Œæ½›å‹¢åœ–ã€
                    if(ncdrEmapLayer && ncdrLayer) {
                        ncdrEmapLayer.addTo(map);
                        setTimeout(() => {
                            map.removeLayer(ncdrEmapLayer);
                            ncdrLayer.addTo(map);
                            // æç¤ºä½¿ç”¨è€…
                            console.log("Switched to flood layer");
                        }, 3000);
                    }
                }

                statusMsg.innerText = "åˆ†æå®Œæˆï¼åœ–å±¤å·²ç–ŠåŠ ";
                document.getElementById('result-temp-desc').innerHTML = 
                    `ç›®å‰æ°£æº« <span class="text-2xl font-bold text-white">${weatherData.temp}Â°C</span><br>${weatherData.risk}`;
                
                document.getElementById('api-debug-info').innerText = `Source: Real APIs (OSM + CWA + NCDR)`;

                document.getElementById('result-flood-desc').innerText = 
                    `å·²å¥—ç–Š NCDR æ·¹æ°´æ½›å‹¢åœ– (600mm)ã€‚è©²å€åŸŸè‹¥æœ‰ç´…/é»ƒè‰²å¡Šï¼Œå»ºè­°å„ªå…ˆè©•ä¼°åŸºåœ°ä¿æ°´æ–¹æ¡ˆã€‚`;

                if(userInput) {
                    document.getElementById('sim-address').value = userInput;
                }

            } catch (e) {
                console.error(e);
                alert("é€£ç·šç•°å¸¸æˆ–ç„¡æ³•å®šä½ï¼Œåˆ‡æ›è‡³å‚™æ´æ¨¡å¼ã€‚");
                // å¤±æ•—æ™‚åˆ‡æ›å› Mock æ¨¡å¼
                const mock = getMockTemp();
                let locationData = MOCK_NTPC_ADDRESS_DB["default"];
                for (const key in MOCK_NTPC_ADDRESS_DB) {
                    if (userInput.includes(key)) {
                        locationData = MOCK_NTPC_ADDRESS_DB[key];
                        break;
                    }
                }
                
                btnText.innerText = 'é‡æ–°åˆ†æ';
                btnLoader.classList.add('hidden');
                resultDiv.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                statusMsg.innerText = "åˆ†æå®Œæˆ (æ¨¡æ“¬æ•¸æ“šæ¨¡å¼)";
                
                document.getElementById('result-temp-desc').innerHTML = 
                    `ç›®å‰æ°£æº« <span class="text-2xl font-bold text-white">${mock.temp}Â°C</span> (æ¨¡æ“¬)<br>${mock.risk}`;
                document.getElementById('api-debug-info').innerText = `Source: Mock Data (Fallback)`;
                
                // å‚™æ´æ¨¡å¼ä¹Ÿè¦è©¦è‘—åŠ åœ–å±¤
                if(map) {
                    map.flyTo([locationData.lat, locationData.lng], 15);
                    L.marker([locationData.lat, locationData.lng]).addTo(map).bindPopup(locationData.name).openPopup();
                    if(ncdrEmapLayer && ncdrLayer) {
                        ncdrEmapLayer.addTo(map);
                        setTimeout(() => {
                            map.removeLayer(ncdrEmapLayer);
                            ncdrLayer.addTo(map);
                        }, 3000);
                    }
                }
            }
        }

        // Feature 2: Simulation Logic
        function updateCalculations() {
            const area = parseInt(document.getElementById('sim-area').value) || 0;
            const households = parseInt(document.getElementById('sim-households').value) || 0;
            const type = document.getElementById('sim-type').value;
            const location = document.getElementById('sim-location').value; // è®€å–ä½ç½®
            const isToggled = document.getElementById('sim-toggle').checked;
            const costPreview = document.getElementById('cost-preview');
            const generateBtn = document.getElementById('btn-generate');
            const householdTypeLabel = document.getElementById('household-type');
            const config = COST_DB[type];

            // Determine subsidy cap based on households
            let maxSubsidy = 0;
            let typeText = "";
            if (households < 150) {
                maxSubsidy = 100000;
                typeText = "å°å‹ç¤¾å€ (è£œåŠ©ä¸Šé™10è¬)";
            } else if (households < 300) {
                maxSubsidy = 200000;
                typeText = "ä¸­å‹ç¤¾å€ (è£œåŠ©ä¸Šé™20è¬)";
            } else {
                maxSubsidy = 300000;
                typeText = "å¤§å‹ç¤¾å€ (è£œåŠ©ä¸Šé™30è¬)";
            }
            householdTypeLabel.innerText = typeText;

            if (!isToggled) {
                costPreview.classList.add('hidden');
                generateBtn.disabled = true;
                return;
            }

            costPreview.classList.remove('hidden');
            generateBtn.disabled = false;

            // ç¶“è²»è¨ˆç®—
            const totalCost = area * config.cost;
            let subsidy = Math.floor(totalCost * config.subsidyRate);
            
            // è£œåŠ©ä¸Šé™æª¢æŸ¥
            let subsidyText = `NT$ ${subsidy.toLocaleString()}`;
            if (subsidy > maxSubsidy) {
                subsidy = maxSubsidy;
                subsidyText = `NT$ ${subsidy.toLocaleString()} (é”ä¸Šé™)`;
            } else {
                subsidyText += ` (${config.subsidyRate*100}%)`;
            }
            
            // æ•ˆç›Šè¨ˆç®—
            let annualSaveVal = area * config.benefitFactor;
            let annualMoneySave = 0;
            if(type === 'water') {
                annualMoneySave = annualSaveVal * WATER_RATE;
            } else {
                annualMoneySave = annualSaveVal * ELECTRICITY_RATE;
            }
            
            // ROI
            const roi = annualMoneySave > 0 ? ((totalCost - subsidy) / annualMoneySave).toFixed(1) : "N/A";

            // Update UI
            document.getElementById('val-total-cost').innerText = `NT$ ${totalCost.toLocaleString()}`;
            document.getElementById('val-subsidy').innerText = subsidyText;
            document.getElementById('val-roi').innerText = `${roi} å¹´`;
            
            // Update Charts UI
            updateCharts(config, isToggled, annualSaveVal, location);
        }

        function updateCharts(config, isToggled, annualBenefit, location) {
            const labelAfter = document.getElementById('visual-label-after');
            const barTemp = document.getElementById('bar-temp');
            const valTemp = document.getElementById('val-temp');
            const barCarbon = document.getElementById('bar-carbon');
            const valCarbon = document.getElementById('val-carbon');
            const title1 = document.getElementById('chart-title-1');
            const title2 = document.getElementById('chart-title-2');

            // Dynamic Chart Settings based on Location
            let chartTitle = config.chart1Title;
            let chartBase = config.chart1Base;
            let chartImprov = config.chart1Improv;
            let visualText = config.visualText;

            // èª¿æ•´ä¸åŒä½ç½®çš„æ¨™é¡Œèˆ‡æ•¸å€¼
            if (location === 'facade') {
                chartTitle = "å¤–ç‰†è¡¨é¢æº«åº¦";
                visualText = "å‚ç›´ç¶ åŒ–å¾Œ";
                if(config.chart1Title.includes("æº«åº¦")) {
                    chartBase = 45; 
                    chartImprov = 30;
                }
            } else if (location === 'ground') {
                chartTitle = "æˆ¶å¤–é«”æ„Ÿæº«åº¦";
                visualText = "ä¸­åº­ç¶ åŒ–å¾Œ";
                if(config.chart1Title.includes("æº«åº¦")) {
                    chartBase = 38;
                    chartImprov = 33;
                }
            }

            // Set dynamic titles
            title1.innerHTML = `<i class="fa-solid fa-chart-line mr-2"></i>${chartTitle}`;
            labelAfter.innerText = visualText;

            if (isToggled) {
                // Temp/Performance Chart
                let widthPercent = 50; 
                if(chartBase > 0) {
                    widthPercent = (chartImprov / chartBase) * 100;
                } else { // Special case for water (0 to 85%)
                    widthPercent = chartImprov; 
                }
                
                barTemp.style.width = `${widthPercent}%`;
                barTemp.classList.replace('bg-red-500', 'bg-brand-green');
                
                let unit = (chartTitle.includes("æº«åº¦")) ? "Â°C" : "%";
                valTemp.innerText = `${chartImprov}${unit}`;
                valTemp.classList.replace('text-red-500', 'text-brand-green');

                // Benefit Chart
                barCarbon.style.width = '80%';
                barCarbon.classList.remove('bg-slate-300');
                barCarbon.classList.add('bg-brand-green');
                valCarbon.innerText = `${annualBenefit.toLocaleString()} ${config.benefitUnit}`;
                valCarbon.classList.add('text-brand-green');
            }
        }

        function toggleSimulation() {
            const isChecked = document.getElementById('sim-toggle').checked;
            const imgBefore = document.getElementById('img-before');
            const imgAfter = document.getElementById('img-after');
            const imgBadge = document.getElementById('img-badge');
            const imgLabel = document.getElementById('img-label');
            const visualLabelAfter = document.getElementById('visual-label-after');
            
            // Fix: Toggle opacity classes based on checked state
            if (isChecked) {
                // Show After, Hide Before
                imgAfter.classList.remove('opacity-0');
                imgAfter.classList.add('opacity-100');
                
                imgBefore.classList.remove('opacity-100');
                imgBefore.classList.add('opacity-0');
                
                imgBadge.classList.replace('bg-white/90', 'bg-brand-green/90');
                imgBadge.classList.replace('text-slate-700', 'text-white');
                imgLabel.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>æ¨¡æ“¬æ”¹å–„æ•ˆæœ';
            } else {
                // Show Before, Hide After
                imgAfter.classList.remove('opacity-100');
                imgAfter.classList.add('opacity-0');
                
                imgBefore.classList.remove('opacity-0');
                imgBefore.classList.add('opacity-100');
                
                imgBadge.classList.replace('bg-brand-green/90', 'bg-white/90');
                imgBadge.classList.replace('text-white', 'text-slate-700');
                imgLabel.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500 mr-2"></i>åŸå§‹é¢¨éšªç‹€æ…‹';
                
                // Reset Charts visual only (logic handled in updateCalculations)
                document.getElementById('bar-temp').style.width = '95%';
                document.getElementById('bar-temp').classList.replace('bg-brand-green', 'bg-red-500');
                document.getElementById('val-temp').classList.replace('text-brand-green', 'text-red-500');
                
                document.getElementById('bar-carbon').style.width = '2%';
                document.getElementById('bar-carbon').classList.remove('bg-brand-green');
                document.getElementById('bar-carbon').classList.add('bg-slate-300');
            }
            updateCalculations();
        }

        // Feature 3: Generate Document
        function generateSubsidyDoc() {
            // Get user input for Org Name and Address
            const orgName = document.getElementById('sim-org-name').value || "ç”³è«‹å–®ä½æœªå¡«å¯«";
            const address = document.getElementById('sim-address').value || "åœ°å€æœªå¡«å¯«";
            
            const area = document.getElementById('sim-area').value;
            const households = document.getElementById('sim-households').value;
            const type = document.getElementById('sim-type').value;
            const locationSelect = document.getElementById('sim-location');
            const locationText = locationSelect.options[locationSelect.selectedIndex].text;
            const config = COST_DB[type];
            
            const totalCostStr = document.getElementById('val-total-cost').innerText;
            const subsidyStr = document.getElementById('val-subsidy').innerText;
            const roiStr = document.getElementById('val-roi').innerText;
            const benefitStr = document.getElementById('val-carbon').innerText;

            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle } = docx;
            
            const cellStyle = {
                borders: {
                    top: { style: BorderStyle.SINGLE, size: 1 },
                    bottom: { style: BorderStyle.SINGLE, size: 1 },
                    left: { style: BorderStyle.SINGLE, size: 1 },
                    right: { style: BorderStyle.SINGLE, size: 1 },
                },
            };

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "114å¹´åº¦æ–°åŒ—å¸‚ä½ç¢³ç¤¾å€æ”¹é€ è£œåŠ©è¨ˆç•«ç”³è«‹è¡¨", heading: docx.HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 400 } }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph({text:"ç”³è«‹å–®ä½", bold:true})], ...cellStyle }), new TableCell({ children: [new Paragraph(orgName)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph({text:"ç¤¾å€åœ°å€", bold:true})], ...cellStyle }), new TableCell({ children: [new Paragraph(address)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph({text:"ç¤¾å€æˆ¶æ•¸", bold:true})], ...cellStyle }), new TableCell({ children: [new Paragraph(households + " æˆ¶")], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph({text:"æ”¹é€ é …ç›®", bold:true})], ...cellStyle }), new TableCell({ children: [new Paragraph(`${config.title} - ${locationText}`)], ...cellStyle }) ]}),
                            ]
                        }),
                        new Paragraph({ text: "\nä¸€ã€æ”¹å–„æ–¹å¼èˆ‡ç¾æ³", heading: docx.HeadingLevel.HEADING_2 }),
                        new Paragraph({ text: `${config.desc} é è¨ˆæ–½ä½œä½ç½®ç‚º ${locationText}ï¼Œé¢ç©ç´„ ${area} åªã€‚` }),
                        new Paragraph({ text: "\näºŒã€ç¶“è²»èˆ‡æ•ˆç›Š", heading: docx.HeadingLevel.HEADING_2 }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("é ä¼°ç¸½ç¶“è²»")], ...cellStyle }), new TableCell({ children: [new Paragraph(totalCostStr)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("ç”³è«‹è£œåŠ©")], ...cellStyle }), new TableCell({ children: [new Paragraph(subsidyStr)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("é ä¼°æ•ˆç›Š")], ...cellStyle }), new TableCell({ children: [new Paragraph(benefitStr)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("å›æ”¶å¹´é™")], ...cellStyle }), new TableCell({ children: [new Paragraph(roiStr)], ...cellStyle }) ]}),
                            ]
                        }),
                        new Paragraph({ text: "\nâ€» ç”± TanJi å¹³å°è‡ªå‹•ç”Ÿæˆã€‚", alignment: AlignmentType.CENTER, color: "888888" })
                    ]
                }]
            });

            Packer.toBlob(doc).then(blob => saveAs(blob, `${orgName}_æ”¹é€ è¨ˆç•«æ›¸.docx`));
        }
    </script>
</body>
</html>
