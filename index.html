<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="碳吉 TanJi - 全台首創社區氣候韌性與 NbS 決策平台">
    <title>碳吉 TanJi - 社區微氣候韌性與 NbS 決策平台</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- docx.js & FileSaver.js -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            green: '#059669', // Emerald 600
                            light: '#d1fae5', // Emerald 100
                            dark: '#064e3b',  // Emerald 900
                            blue: '#0ea5e9',  // Sky 500
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .hero-pattern {
            background-color: #f8fafc;
            background-image: radial-gradient(#059669 0.5px, transparent 0.5px), radial-gradient(#059669 0.5px, #f8fafc 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            opacity: 0.5;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #059669;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #059669;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #059669;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .bar-transition {
            transition: width 1s ease-in-out, background-color 0.5s;
        }
    </style>
</head>
<body class="font-sans text-slate-800 antialiased bg-slate-50">

    <!-- Navigation -->
    <nav class="glass-nav fixed w-full z-50 top-0 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <div class="w-10 h-10 bg-gradient-to-br from-brand-green to-brand-blue rounded-lg flex items-center justify-center text-white font-bold text-xl">
                        <i class="fa-solid fa-leaf"></i>
                    </div>
                    <span class="font-bold text-2xl tracking-tight text-slate-800">碳吉 <span class="text-brand-green font-light">TanJi</span></span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="#features" class="text-slate-600 hover:text-brand-green font-medium transition">核心功能</a>
                    <a href="#demo-scan" class="text-slate-600 hover:text-brand-green font-medium transition">風險快篩</a>
                    <a href="#demo-sim" class="text-slate-600 hover:text-brand-green font-medium transition">效益模擬</a>
                    <a href="#impact" class="text-slate-600 hover:text-brand-green font-medium transition">預期成果</a>
                </div>
                <div>
                    <a href="#demo-scan" class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-2.5 rounded-full font-medium transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        開始免費診斷
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden">
        <div class="absolute inset-0 hero-pattern -z-10"></div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-5xl md:text-7xl font-extrabold text-slate-900 tracking-tight mb-8 leading-tight">
                為您的社區穿上<br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-green to-brand-blue">綠色氣候防護衣</span>
            </h1>
            <p class="max-w-2xl mx-auto text-xl text-slate-600 mb-10 leading-relaxed">
                TanJi 是全台首創的社區氣候韌性決策平台。結合 GIS 大數據與 NbS 自然解方，
                協助管委會從「風險診斷」到「改造補助」一站式完成。
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button onclick="document.getElementById('demo-scan').scrollIntoView({behavior: 'smooth'})" class="px-8 py-4 bg-brand-green hover:bg-emerald-600 text-white text-lg font-bold rounded-xl shadow-lg shadow-emerald-200 transition transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-magnifying-glass-location"></i>
                    檢測我的社區
                </button>
            </div>
            
            <!-- Platform Concept Explainer -->
            <div class="mt-16 relative mx-auto max-w-5xl rounded-2xl shadow-2xl border border-slate-200 overflow-hidden bg-white">
                <div class="bg-gradient-to-r from-slate-50 to-white p-8 md:p-12">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="w-full md:w-1/2 text-left space-y-6">
                            <h3 class="text-2xl font-bold text-slate-800">TanJi 平台運作邏輯</h3>
                            <p class="text-slate-600 text-lg">
                                專為社區管委會設計的氣候調適數位助理。我們不只告訴您「哪裡熱」，更直接提供「怎麼解」的科學方案。
                            </p>
                            <ul class="space-y-4">
                                <li class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="fa-solid fa-database"></i></div>
                                    <div><div class="font-bold text-slate-800">1. 數據匯流</div><div class="text-sm text-slate-500">串接氣象局與新北市GIS圖資</div></div>
                                </li>
                                <li class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i class="fa-solid fa-magnifying-glass-chart"></i></div>
                                    <div><div class="font-bold text-slate-800">2. 風險指認</div><div class="text-sm text-slate-500">AI 判讀都市熱島熱點與淹水潛勢</div></div>
                                </li>
                                <li class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-brand-light flex items-center justify-center text-brand-green"><i class="fa-solid fa-tree"></i></div>
                                    <div><div class="font-bold text-slate-800">3. 自然解方 (NbS)</div><div class="text-sm text-slate-500">推薦適地適種的綠化與保水方案</div></div>
                                </li>
                            </ul>
                        </div>
                        <div class="w-full md:w-1/2 bg-slate-100 rounded-xl p-6 relative">
                            <div class="relative z-10 grid grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><i class="fa-solid fa-cloud-rain text-3xl text-blue-500 mb-2"></i><div class="font-bold text-sm">氣候數據</div></div>
                                <div class="bg-white p-4 rounded-lg shadow-sm text-center"><i class="fa-solid fa-building text-3xl text-slate-500 mb-2"></i><div class="font-bold text-sm">建築圖資</div></div>
                                <div class="col-span-2 bg-brand-green text-white p-4 rounded-lg shadow-lg text-center transform scale-105">
                                    <i class="fa-solid fa-microchip text-3xl mb-2"></i>
                                    <div class="font-bold text-lg">TanJi AI 核心引擎</div>
                                </div>
                                <div class="col-span-2 bg-white p-4 rounded-lg shadow-sm text-center border-t-4 border-brand-green">
                                    <div class="font-bold text-brand-dark">行動計畫書 (Action Plan)</div>
                                </div>
                            </div>
                            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')] opacity-10"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Interactive Demo 1: Risk Scan -->
    <section id="demo-scan" class="py-20 bg-slate-900 text-white relative overflow-hidden">
        <div class="absolute top-0 left-0 w-64 h-64 bg-brand-green rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute bottom-0 right-0 w-64 h-64 bg-brand-blue rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>

        <div class="max-w-4xl mx-auto px-4 relative z-10">
            <div class="text-center mb-12">
                <span class="text-brand-green font-bold tracking-wider uppercase text-sm">Interactive Demo 01</span>
                <h2 class="text-3xl md:text-4xl font-bold mt-2">試試看：社區風險快篩</h2>
                <p class="text-slate-400 mt-4">輸入新北市地址，體驗 AI 診斷流程</p>
            </div>

            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 shadow-2xl">
                <div class="flex flex-col sm:flex-row gap-4 mb-8">
                    <div class="flex-grow relative">
                        <i class="fa-solid fa-location-dot absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="address-input" value="新北市三峽區學勤路1號 (北大特區)" class="w-full bg-slate-800 border border-slate-600 rounded-lg py-4 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:border-brand-green transition" placeholder="請輸入新北市社區地址...">
                    </div>
                    <button onclick="startAnalysis()" class="bg-brand-green hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-lg transition shadow-lg flex items-center justify-center gap-2 min-w-[160px]">
                        <span id="btn-text">開始分析</span>
                        <div id="btn-loader" class="loader hidden w-5 h-5 border-2 border-white border-t-transparent"></div>
                    </button>
                </div>
                
                <div class="mb-6 flex flex-wrap gap-2 justify-center text-xs text-slate-400">
                    <div class="api-status flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full border border-white/10 transition-colors duration-300">
                        <div class="status-dot w-2 h-2 rounded-full bg-slate-500"></div> 串接：新北市門牌位置資料庫
                    </div>
                    <div class="api-status flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full border border-white/10 transition-colors duration-300">
                        <div class="status-dot w-2 h-2 rounded-full bg-slate-500"></div> 串接：NCDR 災害潛勢地圖 API
                    </div>
                    <div class="api-status flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full border border-white/10 transition-colors duration-300">
                        <div class="status-dot w-2 h-2 rounded-full bg-slate-500"></div> 串接：CWA 氣象觀測開放資料
                    </div>
                </div>
                
                <div id="status-message" class="text-center text-sm text-brand-green font-mono h-6 mb-4 opacity-0 transition-opacity">
                    正在連線至 API...
                </div>

                <div id="analysis-result" class="hidden transition-all duration-500 opacity-0 transform translate-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-slate-800 rounded-xl overflow-hidden h-64 relative border border-slate-700 flex items-center justify-center">
                            <div class="absolute inset-0 bg-slate-700">
                                <div class="w-full h-full opacity-30" style="background-image: repeating-linear-gradient(45deg, #475569 0, #475569 1px, transparent 0, transparent 50%); background-size: 10px 10px;"></div>
                            </div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i class="fa-solid fa-map-location-dot text-6xl text-slate-600"></i>
                            </div>
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-red-500 rounded-full filter blur-2xl opacity-40"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg animate-pulse z-10">
                                    <i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="map-alert-text">熱島效應熱點</span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-red-500/20 border border-red-500/50 p-4 rounded-xl flex items-start gap-4">
                                <div class="bg-red-500 p-2 rounded-lg text-white"><i class="fa-solid fa-temperature-full"></i></div>
                                <div>
                                    <h4 class="font-bold text-red-200" id="result-temp-title">極度高溫警示 (板橋區)</h4>
                                    <p class="text-sm text-slate-300 mt-1" id="result-temp-desc">該區域夏季地表均溫達 38.2°C，高於新北市平均 2.5°C。</p>
                                    <p class="text-xs text-slate-400 mt-1" id="api-debug-info"></p>
                                </div>
                            </div>
                            <div class="bg-blue-500/20 border border-blue-500/50 p-4 rounded-xl flex items-start gap-4">
                                <div class="bg-blue-500 p-2 rounded-lg text-white"><i class="fa-solid fa-cloud-showers-heavy"></i></div>
                                <div>
                                    <h4 class="font-bold text-blue-200" id="result-flood-title">排水負荷警示</h4>
                                    <p class="text-sm text-slate-300 mt-1" id="result-flood-desc">短延時強降雨發生機率高，建議提升社區透水率。</p>
                                </div>
                            </div>
                            <div class="bg-brand-green p-4 rounded-xl text-center cursor-pointer hover:bg-emerald-600 transition" onclick="document.getElementById('demo-sim').scrollIntoView({behavior: 'smooth'})">
                                <p class="font-bold text-white"><i class="fa-solid fa-arrow-right mr-2"></i> 前往 NbS 模擬器改善</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Interactive Demo 2: Simulator -->
    <section id="demo-sim" class="py-20 bg-slate-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Layout: Visualizer on LEFT, Controls on RIGHT -->
            <div class="flex flex-col-reverse md:flex-row gap-12 items-start">
                
                <!-- Left: Visualizer -->
                <div class="w-full md:w-2/3 bg-white rounded-3xl shadow-xl p-8 border border-slate-100 relative overflow-hidden flex flex-col h-full">
                    <div class="h-80 rounded-xl bg-slate-200 mb-8 overflow-hidden relative group shrink-0">
                        <div id="img-before" class="absolute inset-0 w-full h-full bg-slate-400 flex items-center justify-center transition-opacity duration-700">
                            <div class="text-center">
                                <i class="fa-solid fa-layer-group text-6xl text-slate-600 mb-2"></i>
                                <p class="text-slate-200 font-bold text-xl">原始現況</p>
                            </div>
                        </div>
                        <div id="img-after" class="absolute inset-0 w-full h-full bg-emerald-600 flex items-center justify-center opacity-0 transition-opacity duration-700">
                             <div class="text-center">
                                <i class="fa-solid fa-seedling text-6xl text-white mb-2"></i>
                                <p class="text-white font-bold text-xl" id="visual-label-after">模擬效果</p>
                            </div>
                        </div>
                        <div class="absolute bottom-4 left-4 bg-black/60 text-white px-3 py-1 rounded text-sm backdrop-blur transition-colors duration-500" id="img-badge">
                            <span id="img-label">原始現況</span>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-base font-bold text-slate-600" id="chart-title-1"><i class="fa-solid fa-temperature-high mr-2"></i>頂樓夏季表面溫度</span>
                                <span id="val-temp" class="text-base font-bold text-red-500">55°C</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-6">
                                <div id="bar-temp" class="bg-red-500 h-6 rounded-full bar-transition shadow-sm" style="width: 95%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-base font-bold text-slate-600" id="chart-title-2"><i class="fa-solid fa-bolt mr-2"></i>年效益評估</span>
                                <span id="val-carbon" class="text-base font-bold text-slate-400">0</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-6">
                                <div id="bar-carbon" class="bg-brand-green h-6 rounded-full bar-transition shadow-sm" style="width: 2%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Controls & Generation -->
                <div class="w-full md:w-1/3 space-y-8 sticky top-24">
                    <div>
                        <span class="text-brand-green font-bold tracking-wider uppercase text-sm">Interactive Demo 02</span>
                        <h2 class="text-3xl font-bold mt-2 text-slate-900">NbS 效益模擬器</h2>
                        <p class="text-slate-600 mt-4" id="sim-desc">
                            選擇適合的氣候韌性方案，系統將自動模擬降溫與減碳效益，並試算政府補助金額。
                        </p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-6">
                        
                        <!-- 1. 選擇改造項目 -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">計畫改造項目</label>
                            <select id="sim-type" onchange="updateCalculations()" class="w-full border border-slate-300 rounded-lg py-2 px-3 focus:ring-2 focus:ring-brand-green outline-none transition text-slate-700 font-medium">
                                <option value="nbs">1. 生物多樣性與綠化 (NbS)</option>
                                <option value="water">2. 水資源再利用 (雨水/透水)</option>
                                <option value="insulation">3. 建築外殼節能 (隔熱)</option>
                            </select>
                        </div>

                        <!-- 2. 社區總戶數 (NEW) -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">社區總戶數</label>
                            <div class="relative">
                                <input type="number" id="sim-households" value="200" oninput="updateCalculations()" class="w-full border border-slate-300 rounded-lg py-2 px-4 focus:ring-2 focus:ring-brand-green focus:border-transparent outline-none transition font-mono text-lg text-right">
                                <span class="absolute left-4 top-2.5 text-slate-400 text-sm"><i class="fa-solid fa-users"></i></span>
                            </div>
                            <p class="text-xs text-slate-400 mt-1" id="household-type">中型社區 (補助上限20萬)</p>
                        </div>

                        <!-- 3. 輸入面積 -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">預計施作面積 (坪)</label>
                            <div class="relative">
                                <input type="number" id="sim-area" value="30" oninput="updateCalculations()" class="w-full border border-slate-300 rounded-lg py-2 px-4 focus:ring-2 focus:ring-brand-green focus:border-transparent outline-none transition font-mono text-lg text-right">
                                <span class="absolute left-4 top-2.5 text-slate-400 text-sm"><i class="fa-solid fa-ruler-combined"></i></span>
                            </div>
                        </div>

                        <!-- 4. 開關模擬 -->
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-slate-700">啟用模擬視圖</span>
                            <div class="relative inline-block w-14 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="sim-toggle" class="toggle-checkbox absolute block w-8 h-8 rounded-full bg-white border-4 border-slate-300 appearance-none cursor-pointer transition-all duration-300 top-[-4px] left-[-4px]" onchange="toggleSimulation()"/>
                                <label for="sim-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <!-- 5. 即時經費試算 -->
                        <div id="cost-preview" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm space-y-3 animate-pulse-fast" style="animation-iteration-count: 1;">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500">預估總經費</span>
                                <span class="font-bold text-slate-800 text-lg" id="val-total-cost">$0</span>
                            </div>
                            <div class="flex justify-between items-center text-brand-green">
                                <span><i class="fa-solid fa-hand-holding-dollar mr-1"></i> 政府補助</span>
                                <span class="font-bold text-lg" id="val-subsidy">$0</span>
                            </div>
                            <div class="flex justify-between items-center border-t border-slate-200 pt-3">
                                <span class="text-slate-500">預估回收年限</span>
                                <span class="font-bold text-slate-800" id="val-roi">-- 年</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <button id="btn-generate" onclick="generateSubsidyDoc()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2 transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa-solid fa-file-signature"></i>
                        一鍵生成改造補助計畫書
                    </button>
                    <p class="text-center text-xs text-slate-400 mt-2">* 自動填入新北市環保局格式表格</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-leaf text-brand-green"></i>
                        <span class="font-bold text-xl">碳吉 TanJi</span>
                    </div>
                    <p class="text-slate-400 text-sm">教育部 115 年度氣候變遷創意實作競賽參賽隊伍</p>
                </div>
                <div class="flex gap-6">
                    <a href="#" class="text-slate-400 hover:text-white transition"><i class="fa-brands fa-github text-2xl"></i></a>
                </div>
            </div>
            <div class="border-t border-slate-800 mt-8 pt-8 text-center text-slate-500 text-sm">
                &copy; 2026 TanJi Project. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // MOCK_DB (省略部分詳細內容以保持簡潔，邏輯與前版相同)
        const MOCK_DB = {
            "北大": { district: "北大特區", temp: 36.8, avgTemp: 1.8, floodRisk: "中", floodDesc: "熱島效應顯著，建議增加綠覆。", apiDebug: "API: New Taipei Housing DB" },
            "板橋": { district: "板橋區", temp: 38.2, avgTemp: 2.5, floodRisk: "高", floodDesc: "不透水鋪面過高，排水負荷大。", apiDebug: "API: NCDR Flood Map" },
            "default": { district: "新北市", temp: 37.0, avgTemp: 1.5, floodRisk: "中", floodDesc: "一般都會區特徵。", apiDebug: "API: OK" }
        };
        let currentData = MOCK_DB["北大"];

        // --- 核心：項目參數設定 (3大重點項目) ---
        const COST_DB = {
            "nbs": { 
                title: "生物多樣性與綠化 (NbS)", 
                cost: 25000, 
                subsidyRate: 0.5, 
                desc: "建置薄層綠屋頂與生態跳島，種植原生耐旱植栽。", 
                benefitUnit: "度電 (空調節能)",
                benefitFactor: 60, // 每坪省電度數
                visualText: "導入綠屋頂後",
                chart1Title: "頂樓夏季表面溫度",
                chart1Base: 55, chart1Improv: 32 // 改善後溫度
            },
            "water": { 
                title: "水資源再利用 (雨水/透水)", 
                cost: 15000, 
                subsidyRate: 0.5, 
                desc: "設置雨水貯留桶與透水鋪面，打造雨水花園。", 
                benefitUnit: "度水 (節省自來水)",
                benefitFactor: 30, // 每坪省水量(噸)
                visualText: "導入雨水回收後",
                chart1Title: "暴雨逕流削減率",
                chart1Base: 0, chart1Improv: 85 // 削減 85%
            },
            "insulation": { 
                title: "建築外殼節能 (隔熱)", 
                cost: 8000, 
                subsidyRate: 0.4, 
                desc: "塗佈高效隔熱漆或鋪設隔熱磚，阻絕熱能傳導。", 
                benefitUnit: "度電 (空調節能)",
                benefitFactor: 40,
                visualText: "施作隔熱工程後",
                chart1Title: "室內天花板溫度",
                chart1Base: 42, chart1Improv: 36
            }
        };

        const ELECTRICITY_RATE = 4.5; 
        const WATER_RATE = 12; // 水費假設
        // const MAX_SUBSIDY = 300000; // Removed constant, now dynamic

        // Feature 1: Map Analysis (Simplified for this demo)
        function startAnalysis() {
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const resultDiv = document.getElementById('analysis-result');
            const statusMsg = document.getElementById('status-message');
            
            btnText.innerText = '分析中...';
            btnLoader.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            statusMsg.classList.remove('opacity-0');
            statusMsg.innerText = "正在連線 NCDR 災害潛勢地圖...";

            setTimeout(() => {
                statusMsg.innerText = "AI 運算完成！";
                btnText.innerText = '重新分析';
                btnLoader.classList.add('hidden');
                resultDiv.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                // 這裡可加入 address 判斷邏輯更新 currentData
            }, 1500);
        }

        // Feature 2: Simulation Logic
        function updateCalculations() {
            const area = parseInt(document.getElementById('sim-area').value) || 0;
            const households = parseInt(document.getElementById('sim-households').value) || 0;
            const type = document.getElementById('sim-type').value;
            const isToggled = document.getElementById('sim-toggle').checked;
            const costPreview = document.getElementById('cost-preview');
            const generateBtn = document.getElementById('btn-generate');
            const householdTypeLabel = document.getElementById('household-type');
            const config = COST_DB[type];

            // Determine subsidy cap based on households
            let maxSubsidy = 0;
            let typeText = "";
            if (households < 150) {
                maxSubsidy = 100000;
                typeText = "小型社區 (補助上限10萬)";
            } else if (households < 300) {
                maxSubsidy = 200000;
                typeText = "中型社區 (補助上限20萬)";
            } else {
                maxSubsidy = 300000;
                typeText = "大型社區 (補助上限30萬)";
            }
            householdTypeLabel.innerText = typeText;

            if (!isToggled) {
                costPreview.classList.add('hidden');
                generateBtn.disabled = true;
                return;
            }

            costPreview.classList.remove('hidden');
            generateBtn.disabled = false;

            // 經費計算
            const totalCost = area * config.cost;
            let subsidy = Math.floor(totalCost * config.subsidyRate);
            
            // 補助上限檢查
            let subsidyText = `NT$ ${subsidy.toLocaleString()}`;
            if (subsidy > maxSubsidy) {
                subsidy = maxSubsidy;
                subsidyText = `NT$ ${subsidy.toLocaleString()} (達上限)`;
            } else {
                subsidyText += ` (${config.subsidyRate*100}%)`;
            }
            
            // 效益計算
            let annualSaveVal = area * config.benefitFactor;
            let annualMoneySave = 0;
            if(type === 'water') {
                annualMoneySave = annualSaveVal * WATER_RATE;
            } else {
                annualMoneySave = annualSaveVal * ELECTRICITY_RATE;
            }
            
            // ROI
            const roi = annualMoneySave > 0 ? ((totalCost - subsidy) / annualMoneySave).toFixed(1) : "N/A";

            // Update UI
            document.getElementById('val-total-cost').innerText = `NT$ ${totalCost.toLocaleString()}`;
            document.getElementById('val-subsidy').innerText = subsidyText;
            document.getElementById('val-roi').innerText = `${roi} 年`;
            
            // Update Charts UI
            updateCharts(config, isToggled, annualSaveVal);
        }

        function updateCharts(config, isToggled, annualBenefit) {
            const labelAfter = document.getElementById('visual-label-after');
            const barTemp = document.getElementById('bar-temp');
            const valTemp = document.getElementById('val-temp');
            const barCarbon = document.getElementById('bar-carbon');
            const valCarbon = document.getElementById('val-carbon');
            const title1 = document.getElementById('chart-title-1');
            const title2 = document.getElementById('chart-title-2');

            // Set dynamic titles
            title1.innerHTML = `<i class="fa-solid fa-chart-line mr-2"></i>${config.chart1Title}`;
            labelAfter.innerText = config.visualText;

            if (isToggled) {
                // Temp/Performance Chart
                let widthPercent = 50; 
                if(config.chart1Base > 0) {
                    widthPercent = (config.chart1Improv / config.chart1Base) * 100;
                } else { // Special case for water (0 to 85%)
                    widthPercent = config.chart1Improv; 
                }
                
                barTemp.style.width = `${widthPercent}%`;
                barTemp.classList.replace('bg-red-500', 'bg-brand-green');
                
                let unit = (config.chart1Title.includes("溫度")) ? "°C" : "%";
                valTemp.innerText = `${config.chart1Improv}${unit}`;
                valTemp.classList.replace('text-red-500', 'text-brand-green');

                // Benefit Chart
                barCarbon.style.width = '80%';
                barCarbon.classList.remove('bg-slate-300');
                barCarbon.classList.add('bg-brand-green');
                valCarbon.innerText = `${annualBenefit.toLocaleString()} ${config.benefitUnit}`;
                valCarbon.classList.add('text-brand-green');
            }
        }

        function toggleSimulation() {
            const isChecked = document.getElementById('sim-toggle').checked;
            const imgAfter = document.getElementById('img-after');
            const imgBadge = document.getElementById('img-badge');
            
            if (isChecked) {
                imgAfter.classList.remove('opacity-0');
                imgBadge.classList.replace('bg-black/60', 'bg-brand-green/90');
                document.getElementById('img-label').innerText = '模擬效果';
            } else {
                imgAfter.classList.add('opacity-0');
                imgBadge.classList.replace('bg-brand-green/90', 'bg-black/60');
                document.getElementById('img-label').innerText = '原始現況';
                
                // Reset Charts visual only (logic handled in updateCalculations)
                document.getElementById('bar-temp').style.width = '95%';
                document.getElementById('bar-temp').classList.replace('bg-brand-green', 'bg-red-500');
                document.getElementById('val-temp').classList.replace('text-brand-green', 'text-red-500');
                
                document.getElementById('bar-carbon').style.width = '2%';
                document.getElementById('bar-carbon').classList.remove('bg-brand-green');
                document.getElementById('bar-carbon').classList.add('bg-slate-300');
            }
            updateCalculations();
        }

        // Feature 3: Generate Document
        function generateSubsidyDoc() {
            const address = document.getElementById('address-input').value;
            const area = document.getElementById('sim-area').value;
            const households = document.getElementById('sim-households').value;
            const type = document.getElementById('sim-type').value;
            const config = COST_DB[type];
            
            const totalCostStr = document.getElementById('val-total-cost').innerText;
            const subsidyStr = document.getElementById('val-subsidy').innerText;
            const roiStr = document.getElementById('val-roi').innerText;
            const benefitStr = document.getElementById('val-carbon').innerText;

            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle } = docx;
            
            const cellStyle = {
                borders: {
                    top: { style: BorderStyle.SINGLE, size: 1 },
                    bottom: { style: BorderStyle.SINGLE, size: 1 },
                    left: { style: BorderStyle.SINGLE, size: 1 },
                    right: { style: BorderStyle.SINGLE, size: 1 },
                },
            };

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "114年度新北市低碳社區改造補助計畫申請表", heading: docx.HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 400 } }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph({text:"申請單位", bold:true})], ...cellStyle }), new TableCell({ children: [new Paragraph(address)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph({text:"社區戶數", bold:true})], ...cellStyle }), new TableCell({ children: [new Paragraph(households + " 戶")], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph({text:"改造項目", bold:true})], ...cellStyle }), new TableCell({ children: [new Paragraph(config.title)], ...cellStyle }) ]}),
                            ]
                        }),
                        new Paragraph({ text: "\n一、改善方式與現況", heading: docx.HeadingLevel.HEADING_2 }),
                        new Paragraph({ text: `${config.desc} 預計施作面積 ${area} 坪。` }),
                        new Paragraph({ text: "\n二、經費與效益", heading: docx.HeadingLevel.HEADING_2 }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("預估總經費")], ...cellStyle }), new TableCell({ children: [new Paragraph(totalCostStr)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("申請補助")], ...cellStyle }), new TableCell({ children: [new Paragraph(subsidyStr)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("預估效益")], ...cellStyle }), new TableCell({ children: [new Paragraph(benefitStr)], ...cellStyle }) ]}),
                                new TableRow({ children: [ new TableCell({ children: [new Paragraph("回收年限")], ...cellStyle }), new TableCell({ children: [new Paragraph(roiStr)], ...cellStyle }) ]}),
                            ]
                        }),
                        new Paragraph({ text: "\n※ 由 TanJi 平台自動生成。", alignment: AlignmentType.CENTER, color: "888888" })
                    ]
                }]
            });

            Packer.toBlob(doc).then(blob => saveAs(blob, `${address}_改造計畫書.docx`));
        }
    </script>
</body>
</html>
